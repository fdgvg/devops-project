trigger:
  - main

# Load secret variables from Azure DevOps variable group
variables:
- group: sec variable  # Replace with your actual variable group name

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Deployment'
    jobs:
      - job: TerraformJob
        displayName: 'Deploy Terraform Infra'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Terraform Init + Import + Apply'
            inputs:
              azureSubscription: 'AzureSPN'  # Replace with your service connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "‚úÖ Exporting Azure authentication ENV vars..."
                export ARM_SUBSCRIPTION_ID=$(subscription_id)
                export ARM_TENANT_ID=$(tenant_id)
                export ARM_CLIENT_ID=$(client_id)
                export ARM_CLIENT_SECRET=$(client_secret)

                echo "üìÅ Switching to infra folder..."
                cd infra

                echo "üîß Initializing Terraform..."
                terraform init

                echo "üì• Importing existing Resource Group..."
                terraform import azurerm_resource_group.rg "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/devops-rg" || true

                echo "üì• Importing existing App Service Plan..."
                terraform import azurerm_app_service_plan.plan "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/devops-rg/providers/Microsoft.Web/serverFarms/devops-plan" || true

                echo "üöÄ Running Terraform apply..."
                terraform apply -auto-approve

                echo "üéâ Deployment completed"
