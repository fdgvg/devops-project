trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: sec variable  # <-- Name of your variable group in Azure DevOps

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Deployment'
    jobs:
      - job: Deploy_Terraform
        displayName: 'Deploy Terraform Infra'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Terraform Init + Import + Apply'
            inputs:
              azureSubscription: 'AzureSPN'  # Your service connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd infra
                export ARM_CLIENT_ID=$(client_id)
                export ARM_CLIENT_SECRET=$(client_secret)
                export ARM_SUBSCRIPTION_ID=$(subscription_id)
                export ARM_TENANT_ID=$(tenant_id)

                terraform init
                terraform import azurerm_resource_group.rg "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/devops-rg" || true
                terraform apply -auto-approve
