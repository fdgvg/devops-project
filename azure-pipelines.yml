trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '18.x'
  displayName: 'Install Node.js'

- script: |
    npm install
    npm start &
  displayName: 'Install dependencies and start app'

stages:
- stage: Terraform_Deploy
  displayName: 'Terraform Deployment'
  jobs:
    - job: TerraformJob
      displayName: 'Terraform Init & Apply'
      pool:
        vmImage: ubuntu-latest
      steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.x'

        - task: TerraformInstaller@0
          inputs:
            terraformVersion: 'latest'

        - checkout: self

        - script: |
            cd infra
            terraform init
            terraform plan
            terraform apply -auto-approve
          displayName: 'Run Terraform'

