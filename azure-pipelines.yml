trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: sec variable  # ğŸ‘ˆ This links the variable group you created

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Deployment'
    jobs:
      - job: TerraformJob
        displayName: 'Deploy Terraform Infra'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Terraform Init + Import + Apply'
            inputs:
              azureSubscription: 'AzureSPN'  # Replace with your service connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ” Exporting ARM_* credentials..."
                export ARM_SUBSCRIPTION_ID=$(subscription_id)
                export ARM_TENANT_ID=$(tenant_id)
                export ARM_CLIENT_ID=$(client_id)
                export ARM_CLIENT_SECRET=$(client_secret)

                echo "ğŸ“ Moving into infra folder"
                cd infra

                echo "ğŸ“¦ Running terraform init"
                terraform init

                echo "ğŸ“¥ Importing Resource Group"
                terraform import azurerm_resource_group.rg "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/devops-rg" || true

                echo "ğŸ“¥ Importing App Service Plan"
                terraform import azurerm_app_service_plan.plan "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/devops-rg/providers/Microsoft.Web/serverFarms/devops-plan" || true

                echo "ğŸš€ Running terraform apply"
                terraform apply -auto-approve
